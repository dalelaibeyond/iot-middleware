<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Middleware v3 - Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1, h2 { color: #2c3e50; }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .try-it {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .try-it:hover { background: #45a049; }
        .response {
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>IoT Middleware v3</h1>
    
    <h2>Overview</h2>
    <p>
        This middleware service bridges MQTT-enabled IoT devices with applications by:
        <ul>
            <li>Normalizing raw MQTT messages into a unified JSON format</li>
            <li>Storing the latest readings in memory for fast access</li>
            <li>Persisting historical data in MySQL</li>
            <li>Providing REST APIs for data access</li>
        </ul>
    </p>

    <h2>API Documentation</h2>
    
    <h3>1. Get Latest Data (All Sensors)</h3>
    <pre>GET /api/latest</pre>
    <button class="try-it" onclick="tryLatest()">Try It!</button>
    <pre id="latestResponse" class="response"></pre>

    <h3>2. Get Latest Data (Single Sensor)</h3>
    <pre>GET /api/latest/:deviceId</pre>
    
    <h3>3. Get Sensor History</h3>
    <pre>GET /api/history/:deviceId?limit=50</pre>

    <h2>Message Format</h2>
    <pre>
{
  "deviceId": "string",        // unique device id
  "sensorType": "string",      // e.g. "temperature"
  "ts": "2025-09-24T08:12:23.456Z", // ISO8601 UTC timestamp
  "seq": 12345,                // optional sequence number
  "payload": {                 // sensor-specific data
     "temp": 28.3,
     "unit": "C"
  },
  "meta": {                    // metadata
     "rawTopic": "sensors/gateway-1/temp",
     "gatewayId": "gateway-1"
  }
}</pre>

    <script>
        async function tryLatest() {
            const response = document.getElementById('latestResponse');
            response.style.display = 'block';
            
            try {
                const res = await fetch('/api/latest');
                const data = await res.json();
                response.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                response.textContent = `Error: ${err.message}`;
            }
        }
    </script>
</body>
</html>
